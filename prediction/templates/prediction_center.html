{% extends 'base.html' %}
{% load static %}

{% block title %}Prediction Center{% endblock %}

{% block content %}
<div class="container-xcore">
  <!-- Header dengan Link My Votes -->
  <div class="prediction-header">
    <div>
      <h2 class="prediction-title">üéØ Prediction Center</h2>
      <p class="prediction-subtitle">Cast your vote and predict the winners!</p>
    </div>
    
    {% if user.is_authenticated %}
      <a href="{% url 'prediction:my_votes' %}" class="btn-my-votes">
        üìä My Votes
      </a>
    {% endif %}
  </div>

  <!-- Upcoming Predictions -->
  {% if upcoming_predictions %}
    <div class="section-header">
      <h3>‚è∞ Upcoming Matches</h3>
    </div>
    <div class="predictions-grid">
      {% for prediction in upcoming_predictions %}
        <div class="prediction-card">
          <div class="match-info">
            <div class="team">
              <span class="team-name">{{ prediction.match.home_team }}</span>
            </div>
            <div class="vs-badge">VS</div>
            <div class="team">
              <span class="team-name">{{ prediction.match.away_team }}</span>
            </div>
          </div>

          <div class="match-details">
            <div class="match-date">üìÖ {{ prediction.match.match_date|date:"d M Y, H:i" }}</div>
            <div class="match-stadium">üìç {{ prediction.match.stadium }}</div>
          </div>

          <!-- Check if user already voted -->
          {% if user.is_authenticated %}
            {% with user_vote=prediction.votes.all|first %}
              {% if user_vote and user_vote.user == user %}
                <div class="already-voted">
                  ‚úÖ You voted: 
                  {% if 'home' in user_vote.choice.lower %}
                    {{ prediction.match.home_team }}
                  {% elif 'away' in user_vote.choice.lower %}
                    {{ prediction.match.away_team }}
                  {% else %}
                    {{ user_vote.choice }}
                  {% endif %}
                </div>
                <a href="{% url 'prediction:my_votes' %}" class="vote-btn voted">
                  View My Votes
                </a>
              {% else %}
                <button class="vote-btn" 
                    data-prediction-id="{{ prediction.id }}" 
                    data-home="{{ prediction.match.home_team }}"
                    data-away="{{ prediction.match.away_team }}">
                  üó≥Ô∏è Vote Now
                </button>
              {% endif %}
            {% endwith %}
          {% else %}
            <a href="{% url 'landingpage:login' %}" class="vote-btn">
              üó≥Ô∏è Login to Vote
            </a>
          {% endif %}

          <!-- Vote Results -->
          <div class="vote-results" id="results-{{ prediction.id }}">
            <div class="result-bar">
              <div class="result-item">
                <span class="result-label">{{ prediction.match.home_team }}</span>
                <div class="progress-bar">
                  <div class="progress-fill" style="width: {{ prediction.home_percentage }}%"></div>
                </div>
                <span class="result-value">{{ prediction.votes_home_team }} votes ({{ prediction.home_percentage|floatformat:1 }}%)</span>
              </div>
              
              <div class="result-item">
                <span class="result-label">{{ prediction.match.away_team }}</span>
                <div class="progress-bar">
                  <div class="progress-fill" style="width: {{ prediction.away_percentage }}%"></div>
                </div>
                <span class="result-value">{{ prediction.votes_away_team }} votes ({{ prediction.away_percentage|floatformat:1 }}%)</span>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Live Predictions -->
  {% if live_predictions %}
    <div class="section-header">
      <h3>üî¥ Live Now</h3>
    </div>
    <div class="predictions-grid">
      {% for prediction in live_predictions %}
        <div class="prediction-card live-card">
          <div class="live-indicator">üî¥ LIVE</div>
          <div class="match-info">
            <div class="team">
              <span class="team-name">{{ prediction.match.home_team }}</span>
            </div>
            <div class="vs-badge">VS</div>
            <div class="team">
              <span class="team-name">{{ prediction.match.away_team }}</span>
            </div>
          </div>

          <div class="match-score">
            <span class="score">{{ prediction.match.home_score }} - {{ prediction.match.away_score }}</span>
          </div>

          <!-- Vote Results -->
          <div class="vote-results">
            <div class="result-bar">
              <div class="result-item">
                <span class="result-label">{{ prediction.match.home_team }}</span>
                <div class="progress-bar">
                  <div class="progress-fill" style="width: {{ prediction.home_percentage }}%"></div>
                </div>
                <span class="result-value">{{ prediction.votes_home_team }} votes ({{ prediction.home_percentage|floatformat:1 }}%)</span>
              </div>
              
              <div class="result-item">
                <span class="result-label">{{ prediction.match.away_team }}</span>
                <div class="progress-bar">
                  <div class="progress-fill" style="width: {{ prediction.away_percentage }}%"></div>
                </div>
                <span class="result-value">{{ prediction.votes_away_team }} votes ({{ prediction.away_percentage|floatformat:1 }}%)</span>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Finished Predictions -->
  {% if finished_predictions %}
    <div class="section-header">
      <h3>‚úÖ Finished Matches</h3>
    </div>
    <div class="predictions-grid">
      {% for prediction in finished_predictions %}
        <div class="prediction-card finished-card">
          <div class="finished-badge">FINISHED</div>
          <div class="match-info">
            <div class="team">
              <span class="team-name">{{ prediction.match.home_team }}</span>
            </div>
            <div class="vs-badge">VS</div>
            <div class="team">
              <span class="team-name">{{ prediction.match.away_team }}</span>
            </div>
          </div>

          <div class="match-score">
            <span class="score">{{ prediction.match.home_score }} - {{ prediction.match.away_score }}</span>
          </div>

          <!-- Vote Results -->
          <div class="vote-results">
            <div class="result-bar">
              <div class="result-item">
                <span class="result-label">{{ prediction.match.home_team }}</span>
                <div class="progress-bar">
                  <div class="progress-fill" style="width: {{ prediction.home_percentage }}%"></div>
                </div>
                <span class="result-value">{{ prediction.votes_home_team }} votes ({{ prediction.home_percentage|floatformat:1 }}%)</span>
              </div>
              
              <div class="result-item">
                <span class="result-label">{{ prediction.match.away_team }}</span>
                <div class="progress-bar">
                  <div class="progress-fill" style="width: {{ prediction.away_percentage }}%"></div>
                </div>
                <span class="result-value">{{ prediction.votes_away_team }} votes ({{ prediction.away_percentage|floatformat:1 }}%)</span>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Empty State -->
  {% if not upcoming_predictions and not live_predictions and not finished_predictions %}
    <div class="empty-state">
      <p>üì≠ No predictions available yet.</p>
    </div>
  {% endif %}
</div>

<!-- Include Modal -->
{% include 'modal/modal_poll.html' %}
{% include 'components/navbar.html' %}
{% include 'components/footer.html' %}

<style>
/* ============================================
   PREDICTION CENTER STYLES
   ============================================ */

.prediction-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 3rem 0 2rem 0;
}

.prediction-title {
  font-size: 2.5rem;
  color: var(--green-darker);
  margin-bottom: 0.5rem;
}

.prediction-subtitle {
  color: var(--blue-normal);
  font-size: 1.1rem;
}

.btn-my-votes {
  background: linear-gradient(135deg, var(--blue-normal), var(--blue-dark));
  color: var(--white-light);
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 600;
  transition: all 0.3s ease;
  white-space: nowrap;
}

.btn-my-votes:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(84, 104, 129, 0.4);
}

.section-header {
  margin: 2rem 0 1.5rem 0;
}

.section-header h3 {
  color: var(--green-darker);
  font-size: 1.8rem;
  border-left: 4px solid var(--green-normal);
  padding-left: 1rem;
}

.predictions-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: 2rem;
  margin-bottom: 3rem;
}

.prediction-card {
  background: var(--white-light);
  border-radius: 16px;
  padding: 2rem;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  transition: all 0.3s ease;
  position: relative;
}

.prediction-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
}

.live-card {
  border: 2px solid #dc3545;
}

.finished-card {
  opacity: 0.85;
}

.live-indicator {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: #dc3545;
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-weight: 700;
  font-size: 0.85rem;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.finished-badge {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: #6c757d;
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-weight: 700;
  font-size: 0.85rem;
}

.match-info {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1.5rem;
}

.team {
  flex: 1;
  text-align: center;
}

.team-name {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--green-darker);
}

.vs-badge {
  background: var(--green-light);
  color: var(--green-darker);
  font-weight: 700;
  padding: 0.5rem 1rem;
  border-radius: 8px;
  margin: 0 1rem;
}

.match-details {
  text-align: center;
  margin-bottom: 1rem;
}

.match-date, .match-stadium {
  color: var(--blue-normal);
  font-size: 0.9rem;
  margin: 0.25rem 0;
}

.match-score {
  text-align: center;
  margin: 1.5rem 0;
}

.match-score .score {
  font-size: 2rem;
  font-weight: 700;
  color: var(--green-darker);
}

.already-voted {
  background: var(--green-light);
  color: var(--green-darker);
  padding: 0.75rem;
  border-radius: 8px;
  text-align: center;
  font-weight: 600;
  margin-bottom: 1rem;
}

.vote-btn {
  width: 100%;
  background: linear-gradient(135deg, var(--green-normal), var(--green-dark));
  color: var(--white-light);
  border: none;
  padding: 1rem;
  border-radius: 12px;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-bottom: 1.5rem;
  text-decoration: none;
  display: block;
  text-align: center;
}

.vote-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(86, 189, 169, 0.4);
}

.vote-btn.voted {
  background: linear-gradient(135deg, var(--blue-normal), var(--blue-dark));
}

/* Vote Results */
.vote-results {
  background: var(--green-light);
  border-radius: 12px;
  padding: 1rem;
}

.result-item {
  margin-bottom: 1rem;
}

.result-item:last-child {
  margin-bottom: 0;
}

.result-label {
  display: block;
  font-weight: 600;
  color: var(--green-darker);
  margin-bottom: 0.5rem;
}

.progress-bar {
  background: var(--white-light);
  height: 24px;
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 0.25rem;
}

.progress-fill {
  background: linear-gradient(90deg, var(--green-normal), var(--green-dark));
  height: 100%;
  transition: width 0.5s ease;
}

.result-value {
  font-size: 0.9rem;
  color: var(--blue-normal);
  font-weight: 500;
}

.empty-state {
  text-align: center;
  padding: 4rem 2rem;
  color: var(--blue-normal);
  font-size: 1.2rem;
}

/* Responsive */
@media (max-width: 768px) {
  .predictions-grid {
    grid-template-columns: 1fr;
  }

  .match-info {
    flex-direction: column;
    gap: 1rem;
  }

  .vs-badge {
    margin: 0;
  }

  .prediction-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 1rem;
  }
}
</style>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i=0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length+1) === (name+'=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length+1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener("DOMContentLoaded", function() {
    const isLoggedIn = {{ request.user.is_authenticated|yesno:"true,false" }};
    const popup = document.getElementById("polling-popup");
    const closeBtn = document.querySelector(".popup-close-btn");

    // Handle vote button clicks
    document.querySelectorAll(".vote-btn").forEach(voteBtn => {
        voteBtn.addEventListener("click", () => {
            if (!isLoggedIn) {
                window.location.href = "/login/?next={{ request.path }}";
            } else {
                const predictionId = voteBtn.dataset.predictionId;
                const homeTeam = voteBtn.dataset.home;
                const awayTeam = voteBtn.dataset.away;

                if (!predictionId) return; // Skip if no prediction ID (e.g., "View My Votes" button)

                // Update modal content
                popup.querySelector(".popup-title").textContent = `Who will win?`;
                popup.querySelector(".team-home span").textContent = homeTeam;
                popup.querySelector(".team-away span").textContent = awayTeam;
                popup.dataset.predictionId = predictionId;

                // Show modal
                popup.classList.remove("hidden");
            }
        });
    });

    // Close modal
    if (closeBtn) {
        closeBtn.addEventListener("click", () => popup.classList.add("hidden"));
    }

    // Close modal when clicking outside
    if (popup) {
        popup.addEventListener("click", (e) => {
            if (e.target === popup) {
                popup.classList.add("hidden");
            }
        });
    }

    // Handle team button clicks
    document.querySelectorAll(".team-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const choice = btn.dataset.team;
            const predictionId = popup.dataset.predictionId;

            if (!predictionId) {
                showToast('Prediction ID tidak ditemukan!', 'error');
                return;
            }

            // Disable buttons
            document.querySelectorAll(".team-btn").forEach(b => b.disabled = true);

            fetch("/prediction/submit-vote/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": getCookie("csrftoken")
                },
                body: `prediction_id=${predictionId}&choice=${choice}`
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === "success") {
                    showToast('Vote berhasil! üéâ', 'success');
                    popup.classList.add("hidden");
                    
                    // Reload page to show updated results
                    window.location.reload();
                } else {
                    showToast(data.message || "Terjadi kesalahan", 'error');
                }
            })
            .catch(error => {
                console.error("Error:", error);
                showToast('Terjadi kesalahan saat mengirim vote', 'error');
            })
            .finally(() => {
                // Re-enable buttons
                document.querySelectorAll(".team-btn").forEach(b => b.disabled = false);
            });
        });
    });
});
</script>

{% endblock %}