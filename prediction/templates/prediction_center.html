{% extends 'base.html' %}
{% load static %}

{% block title %}Prediction Center{% endblock %}

{% block extra_css %}
<style>
    .container-xcore {
    width: 80%;
    max-width: 1200px;
    margin: 0 auto;
    padding-top: var(--navbar-height);
    padding-bottom: 60px;
  }

  .prediction-header {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    margin: 3rem 0 2rem 0;
  }

  .prediction-title {
    font-size: 2.5rem;
    color: var(--green-darker);
    margin-bottom: 0.5rem;
  }

  .prediction-subtitle {
    color: var(--blue-normal);
    font-size: 1.1rem;
  }

  .btn-my-votes {
    background: linear-gradient(135deg, var(--blue-normal), var(--blue-dark));
    color: var(--white-light);
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
    white-space: nowrap;
  }

  .btn-my-votes:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(84, 104, 129, 0.4);
  }

  .predictions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
  }

  .prediction-card {
    background: var(--white-light);
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    position: relative;
  }

  .prediction-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
  }

  .match-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .team-section {
    flex: 1;
    text-align: center;
  }

  .team-name {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--green-darker);
  }

  .vs-separator {
    background: var(--green-light);
    color: var(--green-darker);
    font-weight: 700;
    padding: 0.5rem 1rem;
    border-radius: 8px;
  }

  .match-info-box {
    text-align: center;
    margin-bottom: 1rem;
  }

  .info-row {
    color: var(--blue-normal);
    font-size: 0.9rem;
    margin: 0.25rem 0;
  }

  .btn-vote {
    width: 100%;
    background: linear-gradient(135deg, var(--green-normal), var(--green-dark));
    color: var(--white-light);
    border: none;
    padding: 1rem;
    border-radius: 12px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 1rem;
    text-decoration: none;
    display: block;
    text-align: center;
  }

  .btn-vote:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(86, 189, 169, 0.4);
  }

  .btn-change-vote {
    background: linear-gradient(135deg, var(--blue-normal), var(--blue-dark)) !important;
  }

  .btn-change-vote:hover {
    background: linear-gradient(135deg, var(--blue-dark), var(--blue-normal)) !important;
  }

  .results-section {
    background: var(--green-light);
    border-radius: 12px;
    padding: 1rem;
  }

  .result-row {
    margin-bottom: 1rem;
  }

  .result-header {
    display: flex;
    justify-content: space-between;
    font-weight: 600;
    color: var(--green-darker);
    margin-bottom: 0.5rem;
  }

  .result-bar {
    background: var(--white-light);
    height: 24px;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 0.25rem;
  }

  .result-fill {
    background: linear-gradient(90deg, var(--green-normal), var(--green-dark));
    height: 100%;
    transition: width 0.5s ease;
  }

  .result-votes {
    font-size: 0.9rem;
    color: var(--blue-normal);
    font-weight: 500;
  }

  .empty-state-dynamic {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--blue-normal);
    font-size: 1.2rem;
  }

  @media (max-width: 768px) {
    .predictions-grid {
      grid-template-columns: 1fr;
    }

    .match-header {
      flex-direction: column;
      gap: 1rem;
    }

    .vs-separator {
      margin: 0;
    }
  }

  .tab-btn.btn-back {
      background: linear-gradient(135deg, var(--green-normal), var(--green-dark)) !important;
      color: var(--white-light) !important;
  }

  .tab-btn.btn-back:hover {
      background: linear-gradient(135deg, var(--green-dark), var(--green-normal)) !important;
      color: var(--white-light) !important;
  }

  .voted-badge, .vote-timestamp, .change-vote-trigger, .delete-vote-btn {
      display: none; /* Default hidden, shown via JS or when voted */
  }

  .prediction-card[data-voted="true"] .change-vote-trigger,
  .prediction-card[data-voted="true"] .delete-vote-btn,
  .prediction-card[data-voted="true"] .voted-badge,
  .prediction-card[data-voted="true"] .vote-timestamp {
      display: block; /* Ensure visibility when voted */
  }

  .btn-vote, .change-vote-trigger, .delete-vote-btn, .vote-trigger {
      pointer-events: auto !important;
      position: relative;
      z-index: 10;
  }

  .prediction-card {
      position: relative;
      z-index: 1;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-xcore">
  <a href="{% url 'landingpage:home' %}" class="tab-btn btn-back">‚Üê Back</a>
  <div class="prediction-header fade-in text-center">
    <div>
      <h1 class="prediction-title">Prediction Center</h1>
      <p class="prediction-subtitle">Bet your fate and predict the winners!</p>
    </div>
  </div>

  <div class="tab-navigation-wrapper fade-in">
    <div class="tab-group-left">
      <button class="tab-btn active" data-filter="all">All Matches</button>
      <button class="tab-btn" data-filter="upcoming">Upcoming</button>
      <button class="tab-btn" data-filter="live">Live</button>
      <button class="tab-btn" data-filter="finished">Finished</button>
    </div>
    {% if user.is_authenticated %}
      <div class="tab-group-right">
        <button class="tab-btn tab-my-votes" data-filter="myvotes">üìä My Votes</button>
      </div>
    {% endif %}
  </div>

  <div class="predictions-grid">
    {% for prediction in upcoming_predictions %}
      {% with user_vote=prediction.user_vote %}
      <div class="prediction-card fade-in" 
           data-status="upcoming" 
           data-voted="{% if user_vote %}true{% else %}false{% endif %}"
           data-vote-id="{% if user_vote %}{{ user_vote.id }}{% endif %}"
           data-prediction-id="{{ prediction.id }}"
           data-home-team="{{ prediction.match.home_team }}"
           data-away-team="{{ prediction.match.away_team }}"
           data-match-date="{{ prediction.match.match_date|date:'d M Y, H:i' }}"
           data-match-stadium="{{ prediction.match.stadium }}"
           data-user-choice="{% if user_vote %}{{ user_vote.choice }}{% endif %}"
           data-voted-at="{% if user_vote %}{{ user_vote.voted_at|date:'d M Y, H:i' }}{% endif %}"
           data-home-votes="{{ prediction.votes_home_team }}"
           data-away-votes="{{ prediction.votes_away_team }}"
           data-home-percentage="{{ prediction.home_percentage|floatformat:1 }}"
           data-away-percentage="{{ prediction.away_percentage|floatformat:1 }}">
        
        <div class="status-badge status-upcoming">‚è∞ UPCOMING</div>
        
        <div class="match-header">
          <div class="team-section">
            <span class="team-name">{{ prediction.match.home_team }}</span>
          </div>
          <div class="vs-separator">VS</div>
          <div class="team-section">
            <span class="team-name">{{ prediction.match.away_team }}</span>
          </div>
        </div>

        <div class="match-info-box">
          <div class="info-row">
            <span class="info-icon">üìÖ</span>
            <span class="info-text">{{ prediction.match.match_date|date:"d M Y, H:i" }}</span>
          </div>
          <div class="info-row">
            <span class="info-icon">üìç</span>
            <span class="info-text">{{ prediction.match.stadium }}</span>
          </div>
        </div>

        {% if user.is_authenticated %}
          {% if user_vote %}
            <div class="voted-badge">
              ‚úÖ You voted: 
              {% if user_vote.choice|lower == 'home' %}
                <strong>{{ prediction.match.home_team }}</strong>
              {% elif user_vote.choice|lower == 'away' %}
                <strong>{{ prediction.match.away_team }}</strong>
              {% else %}
                <strong>{{ user_vote.choice }}</strong>
              {% endif %}
            </div>
            <div class="vote-timestamp">
              üïí Voted at {{ user_vote.voted_at|date:"d M Y, H:i" }}
            </div>
            <button class="btn-vote btn-change-vote change-vote-trigger">‚úèÔ∏è Change Vote</button>
            <button class="btn-vote btn-change-vote delete-vote-btn">üóëÔ∏è Delete Vote</button>
          {% endif %}
          <button class="btn-vote vote-trigger" 
                  data-prediction-id="{{ prediction.id }}" 
                  data-home="{{ prediction.match.home_team }}"
                  data-away="{{ prediction.match.away_team }}"
                  {% if user_vote %}style="display: none;"{% endif %}>
            üó≥Ô∏è Vote Now
          </button>
        {% else %}
          <a href="{% url 'landingpage:login' %}" class="btn-vote">
            üó≥Ô∏è Login to Vote
          </a>
        {% endif %}

        <div class="results-section">
          <div class="result-row">
            <div class="result-header">
              <span class="result-team">{{ prediction.match.home_team }}</span>
              <span class="result-percent">{{ prediction.home_percentage|floatformat:1 }}%</span>
            </div>
            <div class="result-bar">
              <div class="result-fill" style="width: {{ prediction.home_percentage }}%"></div>
            </div>
            <div class="result-votes">{{ prediction.votes_home_team }} vote{{ prediction.votes_home_team|pluralize }}</div>
          </div>
          <div class="result-row">
            <div class="result-header">
              <span class="result-team">{{ prediction.match.away_team }}</span>
              <span class="result-percent">{{ prediction.away_percentage|floatformat:1 }}%</span>
            </div>
            <div class="result-bar">
              <div class="result-fill" style="width: {{ prediction.away_percentage }}%"></div>
            </div>
            <div class="result-votes">{{ prediction.votes_away_team }} vote{{ prediction.votes_away_team|pluralize }}</div>
          </div>
        </div>
      </div>
      {% endwith %}
    {% endfor %}

    {% for prediction in live_predictions %}
      {% with user_vote=prediction.user_vote %}
      <div class="prediction-card fade-in" 
           data-status="live"
           data-voted="{% if user_vote %}true{% else %}false{% endif %}"
           data-vote-id="{% if user_vote %}{{ user_vote.id }}{% endif %}"
           data-prediction-id="{{ prediction.id }}"
           data-home-team="{{ prediction.match.home_team }}"
           data-away-team="{{ prediction.match.away_team }}"
           data-match-date="{{ prediction.match.match_date|date:'d M Y, H:i' }}"
           data-match-stadium="{{ prediction.match.stadium }}"
           data-user-choice="{% if user_vote %}{{ user_vote.choice }}{% endif %}"
           data-voted-at="{% if user_vote %}{{ user_vote.voted_at|date:'d M Y, H:i' }}{% endif %}"
           data-home-votes="{{ prediction.votes_home_team }}"
           data-away-votes="{{ prediction.votes_away_team }}"
           data-home-percentage="{{ prediction.home_percentage|floatformat:1 }}"
           data-away-percentage="{{ prediction.away_percentage|floatformat:1 }}">
        
        <div class="status-badge status-live">üî¥ LIVE</div>
        <div class="match-header">
          <div class="team-section">
            <span class="team-name">{{ prediction.match.home_team }}</span>
          </div>
          <div class="vs-separator">VS</div>
          <div class="team-section">
            <span class="team-name">{{ prediction.match.away_team }}</span>
          </div>
        </div>
        <div class="live-score-box">
          <span class="score-display">{{ prediction.match.home_score }} - {{ prediction.match.away_score }}</span>
        </div>
        {% if user.is_authenticated and user_vote %}
          <div class="voted-badge">
            ‚úÖ You voted: 
            {% if user_vote.choice|lower == 'home' %}
              <strong>{{ prediction.match.home_team }}</strong>
            {% elif user_vote.choice|lower == 'away' %}
              <strong>{{ prediction.match.away_team }}</strong>
            {% else %}
              <strong>{{ user_vote.choice }}</strong>
            {% endif %}
          </div>
          <div class="vote-timestamp">
            üïí Voted at {{ user_vote.voted_at|date:"d M Y, H:i" }}
          </div>
          <button class="btn-vote btn-change-vote change-vote-trigger">‚úèÔ∏è Change Vote</button>
          <button class="btn-vote btn-change-vote delete-vote-btn">üóëÔ∏è Delete Vote</button>
        {% endif %}
        <div class="results-section">
          <div class="result-row">
            <div class="result-header">
              <span class="result-team">{{ prediction.match.home_team }}</span>
              <span class="result-percent">{{ prediction.home_percentage|floatformat:1 }}%</span>
            </div>
            <div class="result-bar">
              <div class="result-fill" style="width: {{ prediction.home_percentage }}%"></div>
            </div>
            <div class="result-votes">{{ prediction.votes_home_team }} vote{{ prediction.votes_home_team|pluralize }}</div>
          </div>
          <div class="result-row">
            <div class="result-header">
              <span class="result-team">{{ prediction.match.away_team }}</span>
              <span class="result-percent">{{ prediction.away_percentage|floatformat:1 }}%</span>
            </div>
            <div class="result-bar">
              <div class="result-fill" style="width: {{ prediction.away_percentage }}%"></div>
            </div>
            <div class="result-votes">{{ prediction.votes_away_team }} vote{{ prediction.votes_away_team|pluralize }}</div>
          </div>
        </div>
      </div>
      {% endwith %}
    {% endfor %}

    {% for prediction in finished_predictions %}
      {% with user_vote=prediction.user_vote %}
      <div class="prediction-card fade-in" 
           data-status="finished"
           data-voted="{% if user_vote %}true{% else %}false{% endif %}"
           data-vote-id="{% if user_vote %}{{ user_vote.id }}{% endif %}"
           data-prediction-id="{{ prediction.id }}"
           data-home-team="{{ prediction.match.home_team }}"
           data-away-team="{{ prediction.match.away_team }}"
           data-match-date="{{ prediction.match.match_date|date:'d M Y, H:i' }}"
           data-match-stadium="{{ prediction.match.stadium }}"
           data-user-choice="{% if user_vote %}{{ user_vote.choice }}{% endif %}"
           data-voted-at="{% if user_vote %}{{ user_vote.voted_at|date:'d M Y, H:i' }}{% endif %}"
           data-home-votes="{{ prediction.votes_home_team }}"
           data-away-votes="{{ prediction.votes_away_team }}"
           data-home-percentage="{{ prediction.home_percentage|floatformat:1 }}"
           data-away-percentage="{{ prediction.away_percentage|floatformat:1 }}">
        
        <div class="status-badge status-finished">‚úÖ FINISHED</div>
        <div class="match-header">
          <div class="team-section">
            <span class="team-name">{{ prediction.match.home_team }}</span>
          </div>
          <div class="vs-separator">VS</div>
          <div class="team-section">
            <span class="team-name">{{ prediction.match.away_team }}</span>
          </div>
        </div>
        <div class="final-score-box">
          <span class="score-display">{{ prediction.match.home_score }} - {{ prediction.match.away_score }}</span>
        </div>
        {% if user.is_authenticated and user_vote %}
          <div class="voted-badge">
            ‚úÖ You voted: 
            {% if user_vote.choice|lower == 'home' %}
              <strong>{{ prediction.match.home_team }}</strong>
            {% elif user_vote.choice|lower == 'away' %}
              <strong>{{ prediction.match.away_team }}</strong>
            {% else %}
              <strong>{{ user_vote.choice }}</strong>
            {% endif %}
          </div>
          <div class="vote-timestamp">
            üïí Voted at {{ user_vote.voted_at|date:"d M Y, H:i" }}
          </div>
          <button class="btn-vote btn-change-vote change-vote-trigger">‚úèÔ∏è Change Vote</button>
          <button class="btn-vote btn-change-vote delete-vote-btn">üóëÔ∏è Delete Vote</button>
          <div class="vote-result-info">
            {% if user_vote.choice|lower == 'home' and prediction.match.home_score > prediction.match.away_score %}
              <span class="result-correct">üéâ You predicted correctly!</span>
            {% elif user_vote.choice|lower == 'away' and prediction.match.away_score > prediction.match.home_score %}
              <span class="result-correct">üéâ You predicted correctly!</span>
            {% else %}
              <span class="result-wrong">üòî Better luck next time!</span>
            {% endif %}
          </div>
        {% endif %}
        <div class="results-section">
          <div class="result-row">
            <div class="result-header">
              <span class="result-team">{{ prediction.match.home_team }}</span>
              <span class="result-percent">{{ prediction.home_percentage|floatformat:1 }}%</span>
            </div>
            <div class="result-bar">
              <div class="result-fill" style="width: {{ prediction.home_percentage }}%"></div>
            </div>
            <div class="result-votes">{{ prediction.votes_home_team }} vote{{ prediction.votes_home_team|pluralize }}</div>
          </div>
          <div class="result-row">
            <div class="result-header">
              <span class="result-team">{{ prediction.match.away_team }}</span>
              <span class="result-percent">{{ prediction.away_percentage|floatformat:1 }}%</span>
            </div>
            <div class="result-bar">
              <div class="result-fill" style="width: {{ prediction.away_percentage }}%"></div>
            </div>
            <div class="result-votes">{{ prediction.votes_away_team }} vote{{ prediction.votes_away_team|pluralize }}</div>
          </div>
        </div>
      </div>
      {% endwith %}
    {% endfor %}

    <div class="empty-state-dynamic fade-in" style="display: none;">
      <div class="empty-icon">üì≠</div>
      <h3 class="empty-title">No matches found</h3>
      <p class="empty-message">Check back later!</p>
    </div>
  </div>
</div>
{% endblock %}

{% include 'modal_poll.html' %}
{% include 'modal_delete.html' %}
{% include 'modal_update_vote.html' %}
{% include 'toast.html' %}



{% block extra_js %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}



function refreshCardUI(card) {
    console.log('Refreshing card:', {
        predictionId: card.dataset.predictionId,
        voted: card.dataset.voted,
        voteId: card.dataset.voteId,
        userChoice: card.dataset.userChoice,
        status: card.dataset.status
    });

    const voted = card.dataset.voted === 'true';
    const activeTab = document.querySelector('.tab-btn.active');
    const isMyVotesTab = activeTab && activeTab.dataset.filter === 'myvotes';
    let votedBadge = card.querySelector('.voted-badge');
    let voteTimestamp = card.querySelector('.vote-timestamp');
    let changeVoteBtn = card.querySelector('.change-vote-trigger');
    let deleteVoteBtn = card.querySelector('.delete-vote-btn');
    const voteNowBtn = card.querySelector('.vote-trigger');

    if (!card.querySelector('.results-section')) {
        console.error('Results section not found for card:', card.dataset.predictionId);
        return;
    }

    if (voted) {
        if (!votedBadge) {
            console.log('Creating voted badge for card:', card.dataset.predictionId);
            votedBadge = document.createElement('div');
            votedBadge.className = 'voted-badge';
            votedBadge.innerHTML = `‚úÖ You voted: <strong></strong>`;
            card.insertBefore(votedBadge, card.querySelector('.results-section'));
        }
        if (!voteTimestamp) {
            console.log('Creating vote timestamp for card:', card.dataset.predictionId);
            voteTimestamp = document.createElement('div');
            voteTimestamp.className = 'vote-timestamp';
            card.insertBefore(voteTimestamp, card.querySelector('.results-section'));
        }
        if (!changeVoteBtn && isMyVotesTab) {
            console.log('Creating change vote button for card:', card.dataset.predictionId);
            changeVoteBtn = document.createElement('button');
            changeVoteBtn.className = 'btn-vote btn-change-vote change-vote-trigger';
            changeVoteBtn.textContent = '‚úèÔ∏è Change Vote';
            card.insertBefore(changeVoteBtn, card.querySelector('.results-section'));
        }
        if (!deleteVoteBtn && isMyVotesTab) {
            console.log('Creating delete vote button for card:', card.dataset.predictionId);
            deleteVoteBtn = document.createElement('button');
            deleteVoteBtn.className = 'btn-vote btn-change-vote delete-vote-btn';
            deleteVoteBtn.textContent = 'üóëÔ∏è Delete Vote';
            card.insertBefore(deleteVoteBtn, card.querySelector('.results-section'));
        }

        if (votedBadge) {
            votedBadge.style.display = isMyVotesTab ? 'block' : 'none';
            const choice = (card.dataset.userChoice || '');
            const strongEl = votedBadge.querySelector('strong');
            if (strongEl) {
                strongEl.textContent =
                    choice.toLowerCase().includes('home') ? card.dataset.homeTeam :
                    choice.toLowerCase().includes('away') ? card.dataset.awayTeam : choice || 'Unknown';
            }
        }
        if (voteTimestamp && card.dataset.votedAt) {
            voteTimestamp.style.display = isMyVotesTab ? 'block' : 'none';
            voteTimestamp.textContent = `üïí Voted at ${card.dataset.votedAt}`;
        }
        if (changeVoteBtn) {
            changeVoteBtn.style.display = isMyVotesTab ? 'block' : 'none';
            changeVoteBtn.disabled = false;
        }
        if (deleteVoteBtn) {
            deleteVoteBtn.style.display = isMyVotesTab ? 'block' : 'none';
            deleteVoteBtn.disabled = false;
        }
        if (voteNowBtn) {
            voteNowBtn.style.display = 'none';
        }
    } else {
        if (votedBadge) votedBadge.style.display = 'none';
        if (voteTimestamp) voteTimestamp.style.display = 'none';
        if (changeVoteBtn) changeVoteBtn.style.display = 'none';
        if (deleteVoteBtn) deleteVoteBtn.style.display = 'none';
        if (voteNowBtn) {
            voteNowBtn.style.display = 'block';
            voteNowBtn.disabled = false;
        }
    }
}

function refreshAllCards() {
    console.log('>>> refreshAllCards START');
    try {
        const activeTab = document.querySelector('.tab-btn.active');
        const filter = activeTab ? (activeTab.dataset.filter || 'all') : 'all';
        console.log('Active filter:', filter);

        const predictionCards = Array.from(document.querySelectorAll('.prediction-card'));
        const emptyState = document.querySelector('.empty-state-dynamic');

        // safety normalize dataset flags for all cards (in case missing/undefined)
        predictionCards.forEach(card => {
            const raw = String(card.dataset.voted || '').trim().toLowerCase();
            card.dataset.voted = (raw === 'true' || raw === '1') ? 'true' : 'false';
            if (!('userChoice' in card.dataset)) card.dataset.userChoice = '';
            if (!('votedAt' in card.dataset)) card.dataset.votedAt = '';
            if (!('homeVotes' in card.dataset)) card.dataset.homeVotes = card.dataset.homeVotes || '0';
            if (!('awayVotes' in card.dataset)) card.dataset.awayVotes = card.dataset.awayVotes || '0';
            if (!('homePercentage' in card.dataset)) card.dataset.homePercentage = card.dataset.homePercentage || '0';
            if (!('awayPercentage' in card.dataset)) card.dataset.awayPercentage = card.dataset.awayPercentage || '0';
        });

        let hasVisibleCards = false;

        // Helper: show/hide by inline style so we don't rely on external .hidden class
        function showCard(card) {
            card.style.display = ''; // allow CSS default (block-like) to take effect
            // but ensure block-level layout for grid cards if needed
            if (getComputedStyle(card).display === 'inline') {
                card.style.display = 'block';
            }
            refreshCardUI(card);
            hasVisibleCards = true;
        }
        function hideCard(card) {
            card.style.display = 'none';
        }

        if (filter === 'myvotes') {
            // Show ALL cards that have data-voted="true", regardless of status
            predictionCards.forEach(card => {
                if (card.dataset.voted === 'true') {
                    showCard(card);
                } else {
                    hideCard(card);
                }
            });
        } else if (filter === 'all') {
            // Show everything
            predictionCards.forEach(card => {
                showCard(card);
            });
        } else {
            // Specific status filter (upcoming/live/finished)
            predictionCards.forEach(card => {
                const status = (card.dataset.status || '').toLowerCase();
                if (status === filter) {
                    showCard(card);
                } else {
                    hideCard(card);
                }
            });
        }

        // Empty state handling
        if (emptyState) {
            // choose the appropriate message (keep original mapping)
            const emptyMessages = {
                'all': { icon: 'üì≠', title: 'No predictions available yet', message: 'Check back later for upcoming matches!' },
                'upcoming': { icon: '‚è∞', title: 'No upcoming matches', message: 'All matches have started or finished!' },
                'live': { icon: 'üî¥', title: 'No live matches right now', message: 'Check back when matches are in progress!' },
                'finished': { icon: '‚úÖ', title: 'No finished matches yet', message: 'Come back after matches are completed!' },
                'myvotes': { icon: 'üìä', title: "You haven't voted yet", message: 'Start voting for your favorite teams!' }
            };
            const msg = emptyMessages[filter] || emptyMessages['all'];
            emptyState.querySelector('.empty-icon').textContent = msg.icon;
            emptyState.querySelector('.empty-title').textContent = msg.title;
            emptyState.querySelector('.empty-message').textContent = msg.message;

            // If no visible cards -> show empty area as flex for nicer layout; else hide it
            if (!hasVisibleCards) {
                emptyState.style.display = 'flex';
                emptyState.style.alignItems = 'center';
                emptyState.style.justifyContent = 'center';
                emptyState.style.flexDirection = 'column';
                emptyState.style.padding = '3rem 1rem';
            } else {
                emptyState.style.display = 'none';
            }
        }

        console.log('refreshAllCards finished. visibleCount:', hasVisibleCards ? '>=1' : 0);
    } catch (err) {
        console.error('Error in refreshAllCards:', err);
        showToast('Error', 'Gagal memuat kartu prediksi!', 'error');
    }
}


function openConfirmModal(voteId, homeTeam, awayTeam, choice, callback) {
    console.log('Opening confirm modal for voteId:', voteId);
    const modal = document.getElementById('confirm-modal');
    const message = document.getElementById('confirm-message');
    const confirmBtn = document.getElementById('confirm-yes-btn');

    if (!modal || !message || !confirmBtn) {
        console.error('Confirm modal elements not found:', { modal: !!modal, message: !!message, confirmBtn: !!confirmBtn });
        showToast('Error', 'Modal konfirmasi tidak tersedia!', 'error');
        return;
    }

    modal.dataset.voteId = voteId;
    message.textContent = `Are you sure you want to delete your vote for ${homeTeam} vs ${awayTeam} (${choice})?`;
    modal.classList.remove('hidden');

    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.addEventListener('click', () => {
        console.log('Confirm delete clicked for voteId:', voteId);
        callback();
        modal.classList.add('hidden');
    });
}

document.addEventListener("DOMContentLoaded", function() {
    const isLoggedIn = {{ request.user.is_authenticated|yesno:"true,false" }};
    const popup = document.getElementById("polling-popup");
    const updateModal = document.getElementById("update-vote-modal");
    const confirmModal = document.getElementById("confirm-modal");

    console.log('Page loaded. isLoggedIn:', isLoggedIn, 'Modals:', { popup: !!popup, updateModal: !!updateModal, confirmModal: !!confirmModal });

    [popup, updateModal, confirmModal].forEach(modal => {
        if (modal && !modal.classList.contains('hidden')) {
            modal.classList.add('hidden');
        }
    });

    // --- NORMALIZE data attributes so 'myvotes' filter works reliably ---
    document.querySelectorAll('.prediction-card').forEach(card => {
        // Tambahkan .trim() di sini
        const isVoted = String(card.dataset.voted).trim().toLowerCase() === 'true';
        card.dataset.voted = isVoted ? 'true' : 'false';

    // Also ensure dataset fields used elsewhere exist as strings to avoid undefined errors
    if (!('userChoice' in card.dataset)) card.dataset.userChoice = '';

        // Also ensure dataset fields used elsewhere exist as strings to avoid undefined errors
        if (!('userChoice' in card.dataset)) card.dataset.userChoice = '';
        if (!('votedAt' in card.dataset)) card.dataset.votedAt = '';
        if (!('homeVotes' in card.dataset)) card.dataset.homeVotes = '0';
        if (!('awayVotes' in card.dataset)) card.dataset.awayVotes = '0';
    });
    // ------------------------------------------------------------------

    document.querySelectorAll('.tab-btn[data-filter]').forEach(btn => {
        btn.addEventListener('click', function() {
            console.log('Tab clicked:', this.dataset.filter);
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            refreshAllCards();
            
        });
    });

    document.body.addEventListener('click', function(e) {
        const target = e.target;

        if (target.matches('.vote-trigger')) {
            console.log('Vote trigger clicked:', target.dataset.predictionId);
            if (!isLoggedIn) {
                window.location.href = "/login/?next={{ request.path }}";
                return;
            }
            
            const card = target.closest('.prediction-card');
            if (card.dataset.voted === 'true') {
                showToast('Warning', 'Kamu sudah vote! Gunakan "Change Vote".', 'warning');
                return;
            }
            popup.querySelector(".popup-title").textContent = `Who will win?`;
            const homeSpan = popup.querySelector(".team-btn.team-home span");
            const awaySpan = popup.querySelector(".team-btn.team-away span");
            if (homeSpan) homeSpan.textContent = target.dataset.home || 'Unknown';
            if (awaySpan) awaySpan.textContent = target.dataset.away || 'Unknown';
            popup.dataset.predictionId = target.dataset.predictionId;
            popup.classList.remove("hidden");
        }

        if (target.matches('.change-vote-trigger')) {
            console.log('Change vote clicked:', target.closest('.prediction-card').dataset.voteId);
            const card = target.closest('.prediction-card');
            if (!card || !updateModal) {
                showToast('Error', 'Modal ubah vote tidak tersedia!', 'error');
                return;
            }
            updateModal.dataset.voteId = card.dataset.voteId;
            document.getElementById('update-home-team').textContent = card.dataset.homeTeam;
            document.getElementById('update-away-team').textContent = card.dataset.awayTeam;
            document.getElementById('update-match-date').textContent = 'üìÖ ' + card.dataset.matchDate;
            document.getElementById('update-match-stadium').textContent = 'üìç ' + card.dataset.matchStadium;
            // safe guard userChoice usage
            const safeChoice = (card.dataset.userChoice || '').toLowerCase();
            document.getElementById('current-vote-choice').textContent =
                safeChoice.includes('home') ? 'üè† ' + card.dataset.homeTeam :
                safeChoice.includes('away') ? '‚úàÔ∏è ' + card.dataset.awayTeam : card.dataset.userChoice;
            document.getElementById('current-vote-time').textContent = 'Voted on ' + card.dataset.votedAt;
            document.getElementById('update-option-home').textContent = card.dataset.homeTeam;
            document.getElementById('update-option-away').textContent = card.dataset.awayTeam;
            document.getElementById('update-stats-home').textContent = `${card.dataset.homeVotes} votes (${card.dataset.homePercentage}%)`;
            document.getElementById('update-stats-away').textContent = `${card.dataset.awayVotes} votes (${card.dataset.awayPercentage}%)`;
            updateModal.classList.remove('hidden');
        }

        if (target.matches('.delete-vote-btn')) {
            console.log('Delete vote clicked:', target.closest('.prediction-card').dataset.voteId);
            const card = target.closest('.prediction-card');
            if (!card || !confirmModal) {
                console.error('Confirm modal not found');
                showToast('Error', 'Modal konfirmasi tidak tersedia!', 'error');
                return;
            }
            if (!card.dataset.voteId) {
                console.error('Vote ID not found on card:', card.dataset);
                showToast('Error', 'ID vote tidak ditemukan!', 'error');
                return;
            }
            openConfirmModal(
                card.dataset.voteId,
                card.dataset.homeTeam,
                card.dataset.awayTeam,
                (card.dataset.userChoice || '').toLowerCase().includes('home') ? card.dataset.homeTeam : card.dataset.awayTeam,
                () => {
                    fetch(`/prediction/my-votes/delete/${card.dataset.voteId}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': getCookie('csrftoken'),
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(res => {
                        if (!res.ok) throw new Error(`HTTP error: ${res.status}`);
                        return res.json();
                    })
                    .then(data => {
                        console.log('Delete vote response:', data);
                        if (data.status === 'success') {
                            showToast('Success', 'Vote berhasil dihapus! üéâ', 'success');
                            card.dataset.voted = 'false';
                            card.dataset.voteId = '';
                            card.dataset.userChoice = '';
                            card.dataset.votedAt = '';
                            card.dataset.homeVotes = data.votes_home_team || '0';
                            card.dataset.awayVotes = data.votes_away_team || '0';
                            card.dataset.homePercentage = (data.home_percentage || 0).toFixed(1);
                            card.dataset.awayPercentage = (data.away_percentage || 0).toFixed(1);

                            const homeVoteElement = card.querySelector('.results-section .result-row:first-child .result-votes');
                            const awayVoteElement = card.querySelector('.results-section .result-row:last-child .result-votes');
                            const homePercentElement = card.querySelector('.results-section .result-row:first-child .result-percent');
                            const awayPercentElement = card.querySelector('.results-section .result-row:last-child .result-percent');
                            const homeFillElement = card.querySelector('.results-section .result-row:first-child .result-fill');
                            const awayFillElement = card.querySelector('.results-section .result-row:last-child .result-fill');

                            if (homeVoteElement) homeVoteElement.textContent = `${card.dataset.homeVotes} vote${card.dataset.homeVotes !== '1' ? 's' : ''}`;
                            if (awayVoteElement) awayVoteElement.textContent = `${card.dataset.awayVotes} vote${card.dataset.awayVotes !== '1' ? 's' : ''}`;
                            if (homePercentElement) homePercentElement.textContent = `${card.dataset.homePercentage}%`;
                            if (awayPercentElement) awayPercentElement.textContent = `${card.dataset.awayPercentage}%`;
                            if (homeFillElement) homeFillElement.style.width = `${card.dataset.homePercentage}%`;
                            if (awayFillElement) awayFillElement.style.width = `${card.dataset.awayPercentage}%`;

                            refreshAllCards();
                        } else {
                            showToast('Error', data.message || 'Gagal menghapus vote.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Delete vote error:', error);
                        showToast('Error', `Gagal menghapus vote: ${error.message}`, 'error');
                    });
                }
            );
        }

        if (target.matches('.team-btn')) {
            console.log('Team button clicked:', target.dataset.team);
            const predictionId = popup.dataset.predictionId;
            const choice = target.dataset.team;

            if (!predictionId || !['home', 'away'].includes(choice)) {
                showToast('Error', 'Invalid prediction or choice!', 'error');
                return;
            }

            target.disabled = true;
            fetch("{% url 'prediction:submit_vote' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: `prediction_id=${predictionId}&choice=${choice}`
            })
            .then(res => {
                if (!res.ok) throw new Error(`HTTP error: ${res.status}`);
                return res.json();
            })
            .then(data => {
                console.log('Vote response:', data);
                if (data.status === 'success') {
                    showToast('Success', 'Vote berhasil! üéâ', 'success');
                    popup.classList.add('hidden');
                    const card = document.querySelector(`[data-prediction-id="${predictionId}"]`);
                    if (card) {
                        card.dataset.voted = 'true';
                        card.dataset.voteId = data.vote_id || '';
                        card.dataset.userChoice = choice;
                        card.dataset.votedAt = data.voted_at || new Date().toISOString();
                        card.dataset.homeVotes = data.votes_home_team || '0';
                        card.dataset.awayVotes = data.votes_away_team || '0';
                        card.dataset.homePercentage = (data.home_percentage || 0).toFixed(1);
                        card.dataset.awayPercentage = (data.away_percentage || 0).toFixed(1);

                        const homeVoteElement = card.querySelector('.results-section .result-row:first-child .result-votes');
                        const awayVoteElement = card.querySelector('.results-section .result-row:last-child .result-votes');
                        const homePercentElement = card.querySelector('.results-section .result-row:first-child .result-percent');
                        const awayPercentElement = card.querySelector('.results-section .result-row:last-child .result-percent');
                        const homeFillElement = card.querySelector('.results-section .result-row:first-child .result-fill');
                        const awayFillElement = card.querySelector('.results-section .result-row:last-child .result-fill');

                        if (homeVoteElement) homeVoteElement.textContent = `${card.dataset.homeVotes} vote${card.dataset.homeVotes !== '1' ? 's' : ''}`;
                        if (awayVoteElement) awayVoteElement.textContent = `${card.dataset.awayVotes} vote${card.dataset.awayVotes !== '1' ? 's' : ''}`;
                        if (homePercentElement) homePercentElement.textContent = `${card.dataset.homePercentage}%`;
                        if (awayPercentElement) awayPercentElement.textContent = `${card.dataset.awayPercentage}%`;
                        if (homeFillElement) homeFillElement.style.width = `${card.dataset.homePercentage}%`;
                        if (awayFillElement) awayFillElement.style.width = `${card.dataset.awayPercentage}%`;

                        refreshAllCards();
                    }
                } else {
                    showToast('Error', data.message || 'Gagal menyimpan vote.', 'error');
                }
            })
            .catch(error => {
                console.error('Vote error:', error);
                showToast('Error', `Gagal menyimpan vote: ${error.message}`, 'error');
            })
            .finally(() => target.disabled = false);
        }

        if (target.matches('.update-vote-btn')) {
            console.log('Update vote clicked:', target.dataset.choice);
            const choice = target.dataset.choice;
            const voteId = updateModal.dataset.voteId;

            if (!voteId || !choice) {
                showToast('Error', 'Invalid vote ID or choice!', 'error');
                return;
            }

            openConfirmModal(
                voteId,
                updateModal.querySelector('#update-home-team').textContent,
                updateModal.querySelector('#update-away-team').textContent,
                choice === 'home' ? updateModal.querySelector('#update-home-team').textContent : updateModal.querySelector('#update-away-team').textContent,
                () => {
                    target.disabled = true;
                    fetch("{% url 'prediction:update_vote' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': getCookie('csrftoken'),
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: `vote_id=${voteId}&choice=${choice}`
                    })
                    .then(res => {
                        if (!res.ok) throw new Error(`HTTP error: ${res.status}`);
                        return res.json();
                    })
                    .then(data => {
                        console.log('Update vote response:', data);
                        if (data.status === 'success') {
                            showToast('Success', 'Vote berhasil diubah! üéâ', 'success');
                            updateModal.classList.add('hidden');
                            const card = document.querySelector(`[data-vote-id="${voteId}"]`);
                            if (card) {
                                card.dataset.userChoice = choice;
                                card.dataset.votedAt = data.voted_at || new Date().toISOString();
                                card.dataset.homeVotes = data.votes_home_team || '0';
                                card.dataset.awayVotes = data.votes_away_team || '0';
                                card.dataset.homePercentage = (data.home_percentage || 0).toFixed(1);
                                card.dataset.awayPercentage = (data.away_percentage || 0).toFixed(1);

                                const homeVoteElement = card.querySelector('.results-section .result-row:first-child .result-votes');
                                const awayVoteElement = card.querySelector('.results-section .result-row:last-child .result-votes');
                                const homePercentElement = card.querySelector('.results-section .result-row:first-child .result-percent');
                                const awayPercentElement = card.querySelector('.results-section .result-row:last-child .result-percent');
                                const homeFillElement = card.querySelector('.results-section .result-row:first-child .result-fill');
                                const awayFillElement = card.querySelector('.results-section .result-row:last-child .result-fill');

                                if (homeVoteElement) homeVoteElement.textContent = `${card.dataset.homeVotes} vote${card.dataset.homeVotes !== '1' ? 's' : ''}`;
                                if (awayVoteElement) awayVoteElement.textContent = `${card.dataset.awayVotes} vote${card.dataset.awayVotes !== '1' ? 's' : ''}`;
                                if (homePercentElement) homePercentElement.textContent = `${card.dataset.homePercentage}%`;
                                if (awayPercentElement) awayPercentElement.textContent = `${card.dataset.awayPercentage}%`;
                                if (homeFillElement) homeFillElement.style.width = `${card.dataset.homePercentage}%`;
                                if (awayFillElement) awayFillElement.style.width = `${card.dataset.awayPercentage}%`;

                                refreshAllCards();
                            }
                        } else {
                            showToast('Error', data.message || 'Gagal mengubah vote.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Update vote error:', error);
                        showToast('Error', `Gagal mengubah vote: ${error.message}`, 'error');
                    })
                    .finally(() => target.disabled = false);
                }
            );
        }

        if (target.matches('.popup-close-btn') || target === popup || target === updateModal || target === confirmModal) {
            [popup, updateModal, confirmModal].forEach(modal => {
                if (modal && modal.contains(target)) {
                    modal.classList.add('hidden');
                    console.log(`Closed modal: ${modal.id}`);
                }
            });
        }
    });

    try {
        refreshAllCards();
    } catch (error) {
        console.error('Initial refreshAllCards error:', error);
        showToast('Error', 'Gagal memuat halaman!', 'error');
    }
});
</script>
{% endblock %}