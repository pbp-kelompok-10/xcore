{% extends 'base.html' %}
{% load static %}

{% block title %}Prediction Center{% endblock %}

{% block extra_css %}
<style>
  * {
  box-sizing: border-box !important;
}

html, body {
  overflow-x: hidden !important;
  width: 100% !important;
  max-width: 100vw !important;
  margin: 0 !important;
  padding: 0 !important;
}

.container-xcore {
  width: 90% !important;
  max-width: 1400px !important;
  margin: 0 auto !important;
  padding: 120px 1rem 60px 1rem !important;
  box-sizing: border-box !important;
}

.predictions-grid {
  display: grid !important;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)) !important;
  gap: 1.5rem !important;
  width: 100% !important;
  max-width: 100% !important;
  margin: 0 !important;
  padding: 0 !important;
  box-sizing: border-box !important;
}

.prediction-card {
  width: 100% !important;
  max-width: 100% !important;
  box-sizing: border-box !important;
  margin: 0 !important;
}

/* Tab navigation wrapper fix */
.tab-navigation-wrapper {
  width: 100% !important;
  max-width: 100% !important;
  overflow-x: auto !important;
  box-sizing: border-box !important;
}

@media (max-width: 768px) {
  .container-xcore {
    width: 95% !important;
    padding: 120px 0.5rem 60px 0.5rem !important;
  }
  
  .predictions-grid {
    grid-template-columns: 1fr !important;
    gap: 1rem !important;
  }
}

  .prediction-header {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    margin: 3rem 0 2rem 0;
  }

  .prediction-title {
    font-size: 2.5rem;
    color: var(--green-darker);
    margin-bottom: 0.5rem;
  }

  .prediction-subtitle {
    color: var(--blue-normal);
    font-size: 1.1rem;
  }

  .btn-my-votes {
    background: linear-gradient(135deg, var(--blue-normal), var(--blue-dark));
    color: var(--white-light);
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
    white-space: nowrap;
  }

  .btn-my-votes:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(84, 104, 129, 0.4);
  }

  .prediction-card {
    background: var(--white-light);
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    position: relative;
  }

  .prediction-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
  }

  .match-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .team-section {
    flex: 1;
    text-align: center;
  }

  .team-name {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--green-darker);
  }

  .vs-separator {
    background: var(--green-light);
    color: var(--green-darker);
    font-weight: 700;
    padding: 0.5rem 1rem;
    border-radius: 8px;
  }

  .match-info-box {
    text-align: center;
    margin-bottom: 1rem;
  }

  .info-row {
    color: var(--blue-normal);
    font-size: 0.9rem;
    margin: 0.25rem 0;
  }

  .btn-vote {
    width: 100%;
    background: linear-gradient(135deg, var(--green-normal), var(--green-dark));
    color: var(--white-light);
    border: none;
    padding: 1rem;
    border-radius: 12px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 1rem;
    text-decoration: none;
    display: block;
    text-align: center;
  }

  .btn-vote:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(86, 189, 169, 0.4);
  }

  .btn-change-vote {
    background: linear-gradient(135deg, var(--blue-normal), var(--blue-dark)) !important;
  }

  .btn-change-vote:hover {
    background: linear-gradient(135deg, var(--blue-dark), var(--blue-normal)) !important;
  }

  .results-section {
    background: var(--green-light);
    border-radius: 12px;
    padding: 1rem;
  }

  .result-row {
    margin-bottom: 1rem;
  }

  .result-header {
    display: flex;
    justify-content: space-between;
    font-weight: 600;
    color: var(--green-darker);
    margin-bottom: 0.5rem;
  }

  .result-bar {
    background: var(--white-light);
    height: 24px;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 0.25rem;
  }

  .result-fill {
    background: linear-gradient(90deg, var(--green-normal), var(--green-dark));
    height: 100%;
    transition: width 0.5s ease;
  }

  .result-votes {
    font-size: 0.9rem;
    color: var(--blue-normal);
    font-weight: 500;
  }

  .empty-state-dynamic {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--blue-normal);
    font-size: 1.2rem;
  }

  .small-timestamp {
      background: transparent !important; 
      border: none !important;            
      box-shadow: none !important;        
      padding: 0 !important;             
      
      margin-top: 5px;                   
      margin-bottom: 25px;                
      
      font-size: 0.85rem;               
      color: #6c757d;                    
      text-align: center;
      width: 100%;
  }

  .vote-actions-container {
      display: flex;       
      gap: 15px;           
      width: 100%;
      margin-bottom: 10px; 
  }

  .vote-actions-container .btn-vote {
      flex: 1;            
      padding: 15px 10px;  
      margin: 0;
      
      display: flex;              
      align-items: center;
      justify-content: center;
      gap: 8px;
      line-height: 1.2;
  }

  /* Update: Info Pertandingan Satu Baris */
  .match-info-box {
      display: flex !important;        /* Ubah jadi Flexbox */
      justify-content: center;         /* Tengah secara horizontal */
      align-items: center;             /* Tengah secara vertikal */
      gap: 20px;                       /* Jarak antara Tanggal dan Stadium */
      margin-bottom: 1.5rem;
      text-align: center;
      flex-wrap: wrap;                 /* Jaga-jaga kalau layar hp kekecilan, dia turun */
  }

  .info-row {
      margin: 0 !important;            /* Reset margin bawaan */
      display: flex;
      align-items: center;
      gap: 6px;                        /* Jarak icon ke teks */
  }

  /* Update: Sedikit jarak untuk Results Section di posisi baru */
  .results-section {
      margin-bottom: 2rem;             /* Beri jarak ke tombol di bawahnya */
      background: var(--green-light);  /* Pastikan background tetap ada */
      border-radius: 12px;
      padding: 1rem;
  }

  @media (max-width: 768px) {
    .predictions-grid {
      grid-template-columns: 1fr;
    }

    .match-header {
      flex-direction: column;
      gap: 1rem;
    }

    .vs-separator {
      margin: 0;
    }
  }

  .tab-btn.btn-back {
      background: linear-gradient(135deg, var(--green-normal), var(--green-dark)) !important;
      color: var(--white-light) !important;
  }

  .tab-btn.btn-back:hover {
      background: linear-gradient(135deg, var(--green-dark), var(--green-normal)) !important;
      color: var(--white-light) !important;
  }

  .voted-badge, .vote-timestamp, .change-vote-trigger, .delete-vote-btn, .voting-closed {
      margin-bottom: 0.5rem;
  }

  .vote-trigger {
      margin-bottom: 0.5rem;
      display: block;
  }

  .btn-vote, .change-vote-trigger, .delete-vote-btn, .vote-trigger {
      pointer-events: auto !important;
      position: relative;
      z-index: 10;
      width: 100%;
  }

  .prediction-card {
      position: relative;
      z-index: 1;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-xcore">
  <a href="{% url 'landingpage:home' %}" class="tab-btn btn-back">‚Üê Back</a>
  <div class="prediction-header fade-in text-center">
    <div>
      <h1 class="prediction-title">Prediction Center</h1>
      <p class="prediction-subtitle">Bet your fate and predict the winners!</p>
    </div>
  </div>

  <div class="tab-navigation-wrapper fade-in">
    <div class="tab-group-left">
      <button class="tab-btn active" data-filter="all">All Matches</button>
      <button class="tab-btn" data-filter="upcoming">Upcoming</button>
      <button class="tab-btn" data-filter="live">Live</button>
      <button class="tab-btn" data-filter="finished">Finished</button>
    </div>
    {% if user.is_authenticated %}
      <div class="tab-group-right">
        <button class="tab-btn tab-my-votes" data-filter="myvotes">üìä My Votes</button>
      </div>
    {% endif %}
  </div>

  <div class="predictions-grid">
    {% for prediction in upcoming_predictions %}
      {% with user_vote=prediction.user_vote %}
      <div class="prediction-card fade-in" 
          data-status="upcoming" 
          data-voted="{% if user_vote %}true{% else %}false{% endif %}"
          data-vote-id="{% if user_vote %}{{ user_vote.id }}{% endif %}"
          data-prediction-id="{{ prediction.id }}"
          data-home-team="{{ prediction.match.home_team }}"
          data-away-team="{{ prediction.match.away_team }}"
          data-match-start="{{ prediction.match.match_date|date:'c' }}"
          data-match-stadium="{{ prediction.match.stadium }}"
          data-user-choice="{% if user_vote %}{{ user_vote.choice }}{% endif %}"
          data-voted-at="{% if user_vote %}{{ user_vote.voted_at|date:'d M Y, H:i' }}{% endif %}"
          data-home-votes="{{ prediction.votes_home_team }}"
          data-away-votes="{{ prediction.votes_away_team }}"
          data-home-percentage="{{ prediction.home_percentage|floatformat:1 }}"
          data-away-percentage="{{ prediction.away_percentage|floatformat:1 }}">
        
        <div class="status-badge status-upcoming">‚è∞ UPCOMING</div>
        
        <div class="match-header">
          <div class="team-section">
            <span class="team-name">{{ prediction.match.home_team }}</span>
          </div>
          <div class="vs-separator">VS</div>
          <div class="team-section">
            <span class="team-name">{{ prediction.match.away_team }}</span>
          </div>
        </div>

        <div class="match-info-box">
          <div class="info-row">
            <span class="info-icon">üìÖ</span>
            <span class="info-text">{{ prediction.match.match_date|date:"d M Y, H:i" }}</span>
          </div>
          <div class="info-row">
            <span class="info-icon">üìç</span>
            <span class="info-text">{{ prediction.match.stadium }}</span>
          </div>
        </div>

        <div class="results-section">
          <div class="result-row">
            <div class="result-header">
              <span class="result-team">{{ prediction.match.home_team }}</span>
              <span class="result-percent">{{ prediction.home_percentage|floatformat:1 }}%</span>
            </div>
            <div class="result-bar">
              <div class="result-fill" style="width: {{ prediction.home_percentage }}%"></div>
            </div>
            <div class="result-votes">{{ prediction.votes_home_team }} vote{{ prediction.votes_home_team|pluralize }}</div>
          </div>
          <div class="result-row">
            <div class="result-header">
              <span class="result-team">{{ prediction.match.away_team }}</span>
              <span class="result-percent">{{ prediction.away_percentage|floatformat:1 }}%</span>
            </div>
            <div class="result-bar">
              <div class="result-fill" style="width: {{ prediction.away_percentage }}%"></div>
            </div>
            <div class="result-votes">{{ prediction.votes_away_team }} vote{{ prediction.votes_away_team|pluralize }}</div>
          </div>
        </div>

        {% if user.is_authenticated %}
            <div class="voted-badge" style="display: {% if user_vote %}block{% else %}none{% endif %};">
                {% if user_vote %}
                  ‚úÖ You voted: 
                  {% if user_vote.choice|lower == 'home' %}
                    <strong>{{ prediction.match.home_team }}</strong>
                  {% elif user_vote.choice|lower == 'away' %}
                    <strong>{{ prediction.match.away_team }}</strong>
                  {% else %}
                    <strong>{{ user_vote.choice }}</strong>
                  {% endif %}
                {% endif %}
            </div>

            <div class="vote-timestamp small-timestamp" style="display: {% if user_vote %}block{% else %}none{% endif %};">
              {% if user_vote %}
                üïí Voted at {{ user_vote.voted_at|date:"d M Y, H:i" }}
              {% endif %}
            </div>

            <div class="vote-actions-container" style="display: {% if user_vote %}flex{% else %}none{% endif %};">
                <button class="btn-vote btn-change-vote change-vote-trigger"
                        data-prediction-id="{{ prediction.id }}"
                        data-vote-id="{% if user_vote %}{{ user_vote.id }}{% endif %}">
                  üîÑ Change
                </button>
                
                <button class="btn-vote delete-vote-btn"
                        data-vote-id="{% if user_vote %}{{ user_vote.id }}{% endif %}"
                        data-home-team="{{ prediction.match.home_team }}"
                        data-away-team="{{ prediction.match.away_team }}"
                        data-choice="{% if user_vote %}{{ user_vote.choice }}{% endif %}">
                  ‚ùå Delete
                </button>
            </div>

            <button class="btn-vote vote-trigger"
                    style="display: {% if user_vote %}none{% else %}block{% endif %};"
                    data-prediction-id="{{ prediction.id }}"
                    data-home="{{ prediction.match.home_team }}"
                    data-away="{{ prediction.match.away_team }}">
              üó≥Ô∏è Vote Now
            </button>
        {% else %}
          <a href="{% url 'landingpage:login' %}" class="btn-vote">üó≥Ô∏è Login to Vote</a>
        {% endif %}
        
      </div>
      {% endwith %}
    {% endfor %}

    {% for prediction in live_predictions %}
      {% with user_vote=prediction.user_vote %}
      <div class="prediction-card fade-in" 
           data-status="live"
           data-voted="{% if user_vote %}true{% else %}false{% endif %}"
           data-vote-id="{% if user_vote %}{{ user_vote.id }}{% endif %}"
           data-prediction-id="{{ prediction.id }}"
           data-home-team="{{ prediction.match.home_team }}"
           data-away-team="{{ prediction.match.away_team }}"
           data-match-date="{{ prediction.match.match_date|date:'d M Y, H:i' }}"
           data-match-stadium="{{ prediction.match.stadium }}"
           data-user-choice="{% if user_vote %}{{ user_vote.choice }}{% endif %}"
           data-voted-at="{% if user_vote %}{{ user_vote.voted_at|date:'d M Y, H:i' }}{% endif %}"
           data-home-votes="{{ prediction.votes_home_team }}"
           data-away-votes="{{ prediction.votes_away_team }}"
           data-home-percentage="{{ prediction.home_percentage|floatformat:1 }}"
           data-away-percentage="{{ prediction.away_percentage|floatformat:1 }}">
        
        <div class="status-badge status-live">üî¥ LIVE</div>
        <div class="match-header">
          <div class="team-section">
            <span class="team-name">{{ prediction.match.home_team }}</span>
          </div>
          <div class="vs-separator">VS</div>
          <div class="team-section">
            <span class="team-name">{{ prediction.match.away_team }}</span>
          </div>
        </div>
        <div class="match-info-box">
          <div class="info-row">
            <span class="info-icon">üìÖ</span>
            <span class="info-text">{{ prediction.match.match_date|date:"d M Y, H:i" }}</span>
          </div>
          <div class="info-row">
            <span class="info-icon">üìç</span>
            <span class="info-text">{{ prediction.match.stadium }}</span>
          </div>
        </div>
        <div class="live-score-box">
          <span class="score-display">{{ prediction.match.home_score }} - {{ prediction.match.away_score }}</span>
        </div>
        {% if user.is_authenticated %}
          {% with match_date=prediction.match.match_date %}
            {% if match_date|timeuntil > "2 hours" %}
              {% if user_vote %}
                <div class="voted-badge">
                  ‚úÖ You voted: 
                  {% if user_vote.choice|lower == 'home' %}
                    <strong>{{ prediction.match.home_team }}</strong>
                  {% elif user_vote.choice|lower == 'away' %}
                    <strong>{{ prediction.match.away_team }}</strong>
                  {% else %}
                    <strong>{{ user_vote.choice }}</strong>
                  {% endif %}
                </div>
                <div class="vote-timestamp">
                  üïí Voted at {{ user_vote.voted_at|date:"d M Y, H:i" }}
                </div>
                <button class="btn-vote btn-change-vote change-vote-trigger"
                        data-prediction-id="{{ prediction.id }}"
                        data-vote-id="{{ user_vote.id }}">
                  ‚úèÔ∏è Change Vote
                </button>
                <button class="btn-vote btn-change-vote delete-vote-btn"
                        data-prediction-id="{{ prediction.id }}"
                        data-vote-id="{{ user_vote.id }}">
                  üóëÔ∏è Delete Vote
                </button>
              {% else %}
                <button class="btn-vote vote-trigger"
                        data-prediction-id="{{ prediction.id }}"
                        data-home="{{ prediction.match.home_team }}"
                        data-away="{{ prediction.match.away_team }}">
                  üó≥Ô∏è Vote Now
                </button>
                <div class="voting-closed">
                  ‚è∞ Voting closed: Match starts in less than 2 hours
                </div>
              {% endif %}
            {% else %}
              {% if user_vote %}
                <div class="voted-badge">
                  ‚úÖ You voted: 
                  {% if user_vote.choice|lower == 'home' %}
                    <strong>{{ prediction.match.home_team }}</strong>
                  {% elif user_vote.choice|lower == 'away' %}
                    <strong>{{ prediction.match.away_team }}</strong>
                  {% else %}
                    <strong>{{ user_vote.choice }}</strong>
                  {% endif %}
                </div>
                <div class="vote-timestamp">
                  üïí Voted at {{ user_vote.voted_at|date:"d M Y, H:i" }}
                </div>
              {% else %}
                <div class="voting-closed">
                  ‚è∞ Voting closed: Match starts in less than 2 hours
                </div>
              {% endif %}
            {% endif %}
          {% endwith %}
        {% else %}
          <a href="{% url 'landingpage:login' %}" class="btn-vote">
            üó≥Ô∏è Login to Vote
          </a>
        {% endif %}
        <div class="vote-timestamp" style="display:none;"></div>
        <div class="results-section">
          <div class="result-row">
            <div class="result-header">
              <span class="result-team">{{ prediction.match.home_team }}</span>
              <span class="result-percent">{{ prediction.home_percentage|floatformat:1 }}%</span>
            </div>
            <div class="result-bar">
              <div class="result-fill" style="width: {{ prediction.home_percentage }}%"></div>
            </div>
            <div class="result-votes">{{ prediction.votes_home_team }} vote{{ prediction.votes_home_team|pluralize }}</div>
          </div>
          <div class="result-row">
            <div class="result-header">
              <span class="result-team">{{ prediction.match.away_team }}</span>
              <span class="result-percent">{{ prediction.away_percentage|floatformat:1 }}%</span>
            </div>
            <div class="result-bar">
              <div class="result-fill" style="width: {{ prediction.away_percentage }}%"></div>
            </div>
            <div class="result-votes">{{ prediction.votes_away_team }} vote{{ prediction.votes_away_team|pluralize }}</div>
          </div>
        </div>
      </div>
      {% endwith %}
    {% endfor %}

    {% for prediction in finished_predictions %}
      {% with user_vote=prediction.user_vote %}
      <div class="prediction-card fade-in" 
           data-status="finished"
           data-voted="{% if user_vote %}true{% else %}false{% endif %}"
           data-vote-id="{% if user_vote %}{{ user_vote.id }}{% endif %}"
           data-prediction-id="{{ prediction.id }}"
           data-home-team="{{ prediction.match.home_team }}"
           data-away-team="{{ prediction.match.away_team }}"
           data-match-date="{{ prediction.match.match_date|date:'d M Y, H:i' }}"
           data-match-stadium="{{ prediction.match.stadium }}"
           data-user-choice="{% if user_vote %}{{ user_vote.choice }}{% endif %}"
           data-voted-at="{% if user_vote %}{{ user_vote.voted_at|date:'d M Y, H:i' }}{% endif %}"
           data-home-votes="{{ prediction.votes_home_team }}"
           data-away-votes="{{ prediction.votes_away_team }}"
           data-home-percentage="{{ prediction.home_percentage|floatformat:1 }}"
           data-away-percentage="{{ prediction.away_percentage|floatformat:1 }}">
        
        <div class="status-badge status-finished">‚úÖ FINISHED</div>
        <div class="match-header">
          <div class="team-section">
            <span class="team-name">{{ prediction.match.home_team }}</span>
          </div>
          <div class="vs-separator">VS</div>
          <div class="team-section">
            <span class="team-name">{{ prediction.match.away_team }}</span>
          </div>
        </div>
        <div class="match-info-box">
          <div class="info-row">
            <span class="info-icon">üìÖ</span>
            <span class="info-text">{{ prediction.match.match_date|date:"d M Y, H:i" }}</span>
          </div>
          <div class="info-row">
            <span class="info-icon">üìç</span>
            <span class="info-text">{{ prediction.match.stadium }}</span>
          </div>
        </div>
        <div class="final-score-box">
          <span class="score-display">{{ prediction.match.home_score }} - {{ prediction.match.away_score }}</span>
        </div>
        {% if user.is_authenticated and user_vote %}
          <div class="voted-badge">
            ‚úÖ You voted: 
            {% if user_vote.choice|lower == 'home' %}
              <strong>{{ prediction.match.home_team }}</strong>
            {% elif user_vote.choice|lower == 'away' %}
              <strong>{{ prediction.match.away_team }}</strong>
            {% else %}
              <strong>{{ user_vote.choice }}</strong>
            {% endif %}
          </div>
          <div class="vote-timestamp">
            üïí Voted at {{ user_vote.voted_at|date:"d M Y, H:i" }}
          </div>
          <div class="vote-result-info">
            {% if user_vote.choice|lower == 'home' and prediction.match.home_score > prediction.match.away_score %}
              <span class="result-correct">üéâ You predicted correctly!</span>
            {% elif user_vote.choice|lower == 'away' and prediction.match.away_score > prediction.match.home_score %}
              <span class="result-correct">üéâ You predicted correctly!</span>
            {% else %}
              <span class="result-wrong">üòî Better luck next time!</span>
            {% endif %}
          </div>
        {% else %}
          {% if not user.is_authenticated %}
          <div class="login-to-view-vote">
            <a href="{% url 'landingpage:login' %}">Login to view your vote</a>
          </div>
          {% else %}
          <div class="vote-timestamp">
            You have not voted on this match.
          </div>
          {% endif %}
        {% endif %}
        <div class="results-section">
          <div class="result-row">
            <div class="result-header">
              <span class="result-team">{{ prediction.match.home_team }}</span>
              <span class="result-percent">{{ prediction.home_percentage|floatformat:1 }}%</span>
            </div>
            <div class="result-bar">
              <div class="result-fill" style="width: {{ prediction.home_percentage }}%"></div>
            </div>
            <div class="result-votes">{{ prediction.votes_home_team }} vote{{ prediction.votes_home_team|pluralize }}</div>
          </div>
          <div class="result-row">
            <div class="result-header">
              <span class="result-team">{{ prediction.match.away_team }}</span>
              <span class="result-percent">{{ prediction.away_percentage|floatformat:1 }}%</span>
            </div>
            <div class="result-bar">
              <div class="result-fill" style="width: {{ prediction.away_percentage }}%"></div>
            </div>
            <div class="result-votes">{{ prediction.votes_away_team }} vote{{ prediction.votes_away_team|pluralize }}</div>
          </div>
        </div>
      </div>
      {% endwith %}
    {% endfor %}

    <div class="empty-state-dynamic fade-in" style="display: none;">
      <div class="empty-icon">üì≠</div>
      <h3 class="empty-title">No matches found</h3>
      <p class="empty-message">Check back later!</p>
    </div>
  </div>
</div>

{% include 'modal_poll.html' %}
{% include 'modal_delete.html' %}
{% include 'modal_update_vote.html' %}
{% include 'toast.html' %}

{% endblock %}




{% block extra_js %}
{% load static %}
<script src="{% static 'js/prediction_center.js' %}"></script>
<script src="{% static 'js/modal_poll.js' %}"></script>
<script src="{% static 'js/modal_update_vote.js' %}"></script>
<script src="{% static 'js/modal_delete.js' %}"></script>
{% endblock %}
